"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[459],{329:(y,v,E)=>{E.d(v,{A:()=>X});var o=E(54),u=E(747),r=E(182),A=E(849),f=E(538),s=E(605),l=E(368),d=Object.defineProperty,M=(t,e,n)=>e in t?d(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,L=(t,e,n)=>(M(t,typeof e!="symbol"?e+"":e,n),n);const K="ws://127.0.0.1:4000",N=1500,D=class{constructor(){L(this,"socket",null),L(this,"unsentMessages",new Array),L(this,"resendingIntervalId",this.setResendingInterval()),L(this,"send",e=>this.socket!==null&&this.socket.readyState===WebSocket.OPEN?(this.socket.send(JSON.stringify(e)),s.A.emit(o.A.SOCKET_MSG_SENT,e),!0):(this.unsentMessages.push(e),this.resendingIntervalId||(this.resendingIntervalId=this.setResendingInterval()),!1)),L(this,"addListenersToOpenedSocket",e=>{e.addEventListener("message",n=>{const S=JSON.parse(n.data);s.A.emit(o.A.SOCKET_MSG_RECEIVED,S)}),e.addEventListener("close",()=>{l.A.changeSocketState(!1),this.initSocket()})}),L(this,"initSocket",()=>{const e=new WebSocket(K);e.addEventListener("open",()=>{this.socket=e,this.addListenersToOpenedSocket(e),l.A.changeSocketState(!0)}),e.addEventListener("error",()=>{l.A.changeSocketState(!1),this.initSocket()})}),this.initSocket()}setResendingInterval(){return setInterval(()=>{this.unsentMessages=this.unsentMessages.filter(e=>this.send(e)===!1),this.resendingIntervalId!==null&&this.unsentMessages.length===0&&(clearInterval(this.resendingIntervalId),this.resendingIntervalId=null)},N)}};L(D,"singleInstance",new D),L(D,"getInstance",()=>D.singleInstance);let _=D;var g=Object.defineProperty,a=Object.defineProperties,w=Object.getOwnPropertyDescriptors,c=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,C=Object.prototype.propertyIsEnumerable,R=(t,e,n)=>e in t?g(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,m=(t,e)=>{for(var n in e||(e={}))i.call(e,n)&&R(t,n,e[n]);if(c)for(var n of c(e))C.call(e,n)&&R(t,n,e[n]);return t},O=(t,e)=>a(t,w(e)),h=(t,e,n)=>(R(t,typeof e!="symbol"?e+"":e,n),n);const I=_.getInstance();let P=0,F=[];const T=class{};h(T,"sendBtnClickHandler",t=>{const e=(0,A.n1)(t),n=T.createMessageSentHandler(e);s.A.on(o.A.SOCKET_MSG_RECEIVED,n),I.send(e)}),h(T,"createMessageSentHandler",t=>function e(n){n.id===t.id&&s.A.off(o.A.SOCKET_MSG_RECEIVED,e)}),h(T,"messageSendHandler",t=>{var e,n,S;if(t.type===u.A.MSG_SEND){const p=(e=t.payload)==null?void 0:e.message,H=(p==null?void 0:p.from)===((n=f.A.getAuthData())==null?void 0:n.login)?p==null?void 0:p.to:p==null?void 0:p.from;l.A.saveMessage(H,p),(p==null?void 0:p.from)===((S=f.A.getAuthData())==null?void 0:S.login)?s.A.emit(o.A.MESSAGE_SENT,t):l.A.getSelectedContactLogin()===(p==null?void 0:p.from)&&s.A.emit(o.A.MESSAGE_RECEIVED,t)}}),h(T,"messageResponseHandler",t=>{var e;let n=!1;switch(t.type){case u.A.MSG_DELIVERED:break;default:n=!0;break}if(!n){const S=(e=t.payload)==null?void 0:e.message;S&&l.A.updateMessageStatus(S)}}),h(T,"messageReadResponser",t=>{var e,n;if(t.type===u.A.MSG_READ)if(P>0){P-=1;const S=(e=t.payload)==null?void 0:e.message;F.push(S),P===0&&l.A.updateReadMessages(F)}else{const S=(n=t.payload)==null?void 0:n.message;l.A.updateMessageStatus(S)}}),h(T,"fetchUserHistory",t=>{const e=(0,A.qR)(t),n=T.createHistoryResponseHandler(e,t);s.A.on(o.A.SOCKET_MSG_RECEIVED,n),I.send(e)}),h(T,"fetchAllUsersHistory",()=>{[...l.A.getContactsData().keys()].forEach(e=>{T.fetchUserHistory(e)}),s.A.emit(o.A.CONTACTS_UPDATED)}),h(T,"messageReadRequestHandler",t=>{const e=(0,A.h5)(t);I.send(e)}),h(T,"createHistoryResponseHandler",(t,e)=>function n(S){var p;if(S.id===t.id){s.A.off(o.A.SOCKET_MSG_RECEIVED,n);const H=(p=S.payload)==null?void 0:p.messages;H&&l.A.refillContactMsgHistory(e,H)}}),h(T,"messageReadHandler",()=>{const t=l.A.getSelectedContactData();if(P=0,F=[],t){const{messages:e}=t;P=(e==null?void 0:e.filter(n=>{var S,p;return!((S=n.status)!=null&&S.isReaded)&&n.to===((p=f.A.getAuthData())==null?void 0:p.login)}).length)||0,P>0&&(e==null||e.forEach(n=>{var S,p;n.status&&!((S=n.status)!=null&&S.isReaded)&&n.to===((p=f.A.getAuthData())==null?void 0:p.login)&&T.messageReadRequestHandler(n.id)}),l.A.setContactData(l.A.getSelectedContactLogin(),O(m({},t),{unreadMessagesCount:0})),s.A.emit(o.A.CONTACTS_UPDATED))}}),h(T,"deleteHandler",t=>{const e=(0,A.Yo)(t);I.send(e)}),h(T,"deleteResponseHandler",t=>{var e,n;t.type===u.A.MSG_DELETE&&((e=t.payload)!=null&&e.message)&&l.A.deleteMessage((n=t.payload)==null?void 0:n.message)}),h(T,"editHandler",({id:t,text:e})=>{const n=(0,A.H4)(t,e);I.send(n)}),h(T,"editResponseHandler",t=>{var e,n;t.type===u.A.MSG_EDIT&&((e=t.payload)!=null&&e.message)&&l.A.updateMessageStatus((n=t.payload)==null?void 0:n.message)});let G=T;s.A.on(o.A.SEND_BTN_CLICK,G.sendBtnClickHandler),s.A.on(o.A.SOCKET_MSG_RECEIVED,G.messageResponseHandler),s.A.on(o.A.SOCKET_MSG_RECEIVED,G.messageSendHandler),s.A.on(o.A.SOCKET_MSG_RECEIVED,G.messageReadResponser),s.A.on(o.A.SOCKET_MSG_RECEIVED,G.deleteResponseHandler),s.A.on(o.A.SOCKET_MSG_RECEIVED,G.editResponseHandler),s.A.on(o.A.DIALOGUE_CLICK,G.messageReadHandler),s.A.on(o.A.SEND_BTN_CLICK,G.messageReadHandler),s.A.on(o.A.USER_SCROLL,G.messageReadHandler),s.A.on(o.A.DELETE_BTN_CLICK,G.deleteHandler),s.A.on(o.A.SEND_EDITED_BTN_CLICK,G.editHandler);var J=Object.defineProperty,q=(t,e,n)=>e in t?J(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,B=(t,e,n)=>(q(t,typeof e!="symbol"?e+"":e,n),n);const z=2,Y=_.getInstance();let W=0;const b=class{};B(b,"contactsRequestHandler",()=>{W=0;const t=(0,A.Nt)(null,u.A.ACTIVE_USERS),e=(0,A.Nt)(null,u.A.INACTIVE_USERS),n=b.createUsersResponseHandler(t),S=b.createUsersResponseHandler(e);s.A.on(o.A.SOCKET_MSG_RECEIVED,n),Y.send(t),s.A.on(o.A.SOCKET_MSG_RECEIVED,S),Y.send(e)}),B(b,"externalUserHandler",t=>{var e;if(t.type===u.A.LOGIN_EXTERNAL||t.type===u.A.LOGOUT_EXTERNAL){const n=(e=t.payload)==null?void 0:e.user;n&&(l.A.setContactData(n.login,{isOnline:n.isLogined}),n.login===l.A.getSelectedContactLogin()&&l.A.setSelectedContactActivity(n.isLogined)),s.A.emit(o.A.CONTACTS_UPDATED)}}),B(b,"createUsersResponseHandler",t=>function e(n){var S;n.id===t.id&&(s.A.off(o.A.SOCKET_MSG_RECEIVED,e),(((S=n.payload)==null?void 0:S.users)||[]).forEach(H=>{var $;H.login!==(($=f.A.getAuthData())==null?void 0:$.login)&&l.A.setContactData(H.login,{isOnline:H.isLogined,unreadMessagesCount:0,messages:[]})}),W+=1,W===z&&(b.contactSelectionHandler(l.A.getSelectedContactLogin()),G.fetchAllUsersHistory()))}),B(b,"contactSelectionHandler",t=>{l.A.setSelectedContact(t)});let x=b;s.A.on(o.A.SOCKET_MSG_RECEIVED,x.externalUserHandler),s.A.on(o.A.CONTACT_SELECTION_CLICK,x.contactSelectionHandler);var Q=Object.defineProperty,Z=(t,e,n)=>e in t?Q(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,V=(t,e,n)=>(Z(t,typeof e!="symbol"?e+"":e,n),n);const ee=600,j=_.getInstance(),U=class{};V(U,"loginHandler",t=>{const e=U.createAuthResponseHandler(t);s.A.on(o.A.SOCKET_MSG_RECEIVED,e),j.send(t)}),V(U,"logoutHandler",()=>{const t=f.A.getAuthData();if(t){const e=(0,A.Nt)({user:t},u.A.LOGOUT_CURRENT),n=U.createLogoutResponseHandler(e);s.A.on(o.A.SOCKET_MSG_RECEIVED,n),j.send(e)}}),V(U,"socketOpenedHandler",t=>{if(t){const e=f.A.getAuthData();e?U.loginHandler((0,A.Nt)({user:e},u.A.LOGIN_CURRENT)):window.location.hash===`#${r.A.CHAT}`&&(window.location.hash=`#${r.A.LOGIN}`)}}),V(U,"createAuthResponseHandler",t=>function e(n){var S,p;if(n.id===t.id)if(s.A.off(o.A.SOCKET_MSG_RECEIVED,e),n.type===u.A.ERROR)f.A.getAuthData()&&(U.handleInfoClear(),setTimeout(()=>{var H;return s.A.emit(o.A.MODAL_ERROR,(H=n.payload)==null?void 0:H.error)},ee)),window.location.hash===`#${r.A.CHAT}`&&(window.location.hash=`#${r.A.LOGIN}`),s.A.emit(o.A.MODAL_ERROR,(S=n.payload)==null?void 0:S.error);else{const H=(p=t.payload)==null?void 0:p.user;H&&(f.A.setAuthData(H),window.location.hash===`#${r.A.LOGIN}`&&(window.location.hash=`#${r.A.CHAT}`),x.contactsRequestHandler())}}),V(U,"createLogoutResponseHandler",t=>function e(n){var S;n.id===t.id&&(s.A.off(o.A.SOCKET_MSG_RECEIVED,e),n.type===u.A.ERROR?s.A.emit(o.A.MODAL_ERROR,(S=n.payload)==null?void 0:S.error):(U.handleInfoClear(),window.location.hash=`#${r.A.LOGIN}`))}),V(U,"handleInfoClear",()=>{f.A.clearAppData(),l.A.clear()});let X=U;s.A.on(o.A.SOCKET_STATE_CHANGE,X.socketOpenedHandler)},605:(y,v,E)=>{E.d(v,{A:()=>A});var o=Object.defineProperty,u=(f,s,l)=>s in f?o(f,s,{enumerable:!0,configurable:!0,writable:!0,value:l}):f[s]=l,r=(f,s,l)=>(u(f,typeof s!="symbol"?s+"":s,l),l);class A{static on(s,l){const d=this.handlers[s]||[];d.length===0&&(this.handlers[s]=d),d.push(l)}static off(s,l){const d=this.handlers[s];if(d)for(let M=0;M<d.length;M+=1)d[M]===l&&(d.splice(M,1),M-=1)}static emit(s,l){const d=this.handlers[s];d&&d.forEach(M=>M(l))}}r(A,"handlers",{})},368:(y,v,E)=>{E.d(v,{A:()=>w});var o=E(54);function u(c){return c!==null&&typeof c=="object"&&!Array.isArray(c)}function r(c,i){if(!u(i))return c;const C=c;return Object.keys(i).forEach(R=>{const m=i[R];let O=c[R];u(m)&&u(O)?O=r(O,m):O=m,C[R]=O}),C}var A=E(605),f=E(538),s=Object.defineProperty,l=Object.defineProperties,d=Object.getOwnPropertyDescriptors,M=Object.getOwnPropertySymbols,L=Object.prototype.hasOwnProperty,K=Object.prototype.propertyIsEnumerable,N=(c,i,C)=>i in c?s(c,i,{enumerable:!0,configurable:!0,writable:!0,value:C}):c[i]=C,D=(c,i)=>{for(var C in i||(i={}))L.call(i,C)&&N(c,C,i[C]);if(M)for(var C of M(i))K.call(i,C)&&N(c,C,i[C]);return c},_=(c,i)=>l(c,d(i)),g=(c,i,C)=>(N(c,typeof i!="symbol"?i+"":i,C),C);const a=class k{static updateReadMessages(i){i.forEach(C=>{k.updateMessageStatus(C,!1)}),A.A.emit(o.A.MSG_CONTENT_UPDATED)}};g(a,"isSocketOpened",!1),g(a,"selectedContact",null),g(a,"isSelectedContactOnline",!1),g(a,"contactsData",new Map),g(a,"getContactsData",()=>a.contactsData),g(a,"getSelectedContactData",()=>a.selectedContact&&a.contactsData.get(a.selectedContact)||null),g(a,"getSelectedContactLogin",()=>a.selectedContact),g(a,"setSelectedContactActivity",c=>{a.isSelectedContactOnline=c,A.A.emit(o.A.SELECTED_ACTIVITY_CHANGED,c)}),g(a,"getSelectedContactActivity",()=>a.isSelectedContactOnline),g(a,"changeSocketState",c=>{a.isSocketOpened=c,a.clear(),A.A.emit(o.A.SOCKET_STATE_CHANGE,c)}),g(a,"setContactData",(c,i)=>{a.contactsData.has(c)?a.contactsData.set(c,D(D({},a.contactsData.get(c)),i)):a.contactsData.set(c,_(D({},i),{unreadMessagesCount:0,messages:[]}))}),g(a,"clear",()=>{a.contactsData.clear(),a.setSelectedContact(null),a.setSelectedContactActivity(!1)}),g(a,"setSelectedContact",c=>{const i=a.selectedContact;a.selectedContact&&!a.contactsData.has(a.selectedContact)?a.selectedContact=null:a.selectedContact=c,a.selectedContact!==i&&(A.A.emit(o.A.SELECTED_LOGIN_CHANGED,a.selectedContact),a.selectedContact&&a.setSelectedContactActivity(a.contactsData.get(a.selectedContact).isOnline))}),g(a,"saveMessage",(c,i)=>{var C,R;const m=a.contactsData.get(c);if(m){const{messages:O}=m,h=O==null?void 0:O.findIndex(I=>I.datetime>i.datetime);h!==-1?O==null||O.splice(h,0,i):O==null||O.push(i),((C=i.status)==null?void 0:C.isReaded)===!1&&i.to===((R=f.A.getAuthData())==null?void 0:R.login)&&(m.unreadMessagesCount+=1,A.A.emit(o.A.CONTACTS_UPDATED))}c===a.selectedContact&&A.A.emit(o.A.MSG_CONTENT_UPDATED)}),g(a,"updateMessageStatus",(c,i=!0)=>{const C=[...a.contactsData.keys()];for(let R=0;R<C.length;R+=1){const m=C[R],h=a.contactsData.get(m).messages||[];for(let I=0;I<h.length;I+=1){const P=h[I];if(P.id===c.id){r(P,c),m===a.selectedContact&&i&&A.A.emit(o.A.MSG_CONTENT_UPDATED);return}}}}),g(a,"refillContactMsgHistory",(c,i)=>{const C=a.contactsData.get(c);if(C){const R=i.filter(m=>{var O;return!((O=m.status)!=null&&O.isReaded)&&m.from===c}).length;C.messages=i,R!==C.unreadMessagesCount&&(C.unreadMessagesCount=R,A.A.emit(o.A.CONTACTS_UPDATED))}c===a.selectedContact&&A.A.emit(o.A.MSG_CONTENT_UPDATED)}),g(a,"deleteMessage",c=>{var i;const C=[...a.contactsData.keys()];for(let R=0;R<C.length;R+=1){const m=C[R],O=a.contactsData.get(m),h=O.messages||[];for(let I=0;I<h.length;I+=1){const P=h[I];if(P.id===c.id){h.splice(I,1),m===a.selectedContact&&A.A.emit(o.A.MSG_CONTENT_UPDATED),(i=P.status)!=null&&i.isReaded||(O.unreadMessagesCount-=1,A.A.emit(o.A.CONTACTS_UPDATED));return}}}});let w=a},514:(y,v,E)=>{E.d(v,{A:()=>u});var o=E(256);function u({className:r,textContent:A="",buttonType:f="button",clickHandler:s}){return new o.A({tag:"button",className:r,textContent:A,type:f,onclick:s})}},144:(y,v,E)=>{E.d(v,{A:()=>K});var o=E(256),u=E(734),r=E(514),A=E(605),f=E(54),s=Object.defineProperty,l=(N,D,_)=>D in N?s(N,D,{enumerable:!0,configurable:!0,writable:!0,value:_}):N[D]=_,d=(N,D,_)=>(l(N,typeof D!="symbol"?D+"":D,_),_);const M=600,L=10;class K extends o.A{constructor(){super({className:"modal modal--closed"}),d(this,"confirmButton"),d(this,"contentComponent"),d(this,"description"),d(this,"onSocketDisconnect",D=>{D?this.closeModal():(this.description.setTextContent("Server connection lost. Reconnecting..."),this.confirmButton.getNode().style.display="none",this.contentComponent.addClass("modal__content--reconnect"),this.showModal())}),d(this,"onAuthError",D=>{if(!this.contentComponent.hasClass("modal__content--reconnect")){const _=D.charAt(0).toUpperCase()+D.slice(1);this.description.setTextContent(_),this.confirmButton.getNode().style.display="",this.confirmButton.getNode().focus(),document.addEventListener("keydown",this.onDocumentEscapeKeydown),this.getNode().addEventListener("click",this.onModalClick),this.showModal()}}),d(this,"showModal",()=>{setTimeout(()=>{this.addClass("modal--opaque")},L),this.removeClass("modal--closed"),document.body.classList.add("no-scroll")}),d(this,"closeModal",()=>{this.removeClass("modal--opaque"),setTimeout(()=>{this.addClass("modal--closed"),document.body.classList.remove("no-scroll"),this.contentComponent.removeClass("modal__content--reconnect"),document.removeEventListener("keydown",this.onDocumentEscapeKeydown),this.getNode().removeEventListener("click",this.onModalClick)},M)}),d(this,"onDocumentEscapeKeydown",D=>{D.key==="Escape"&&this.closeModal()}),d(this,"onModalClick",D=>{D.composedPath().includes(this.contentComponent.getNode())||this.closeModal()}),this.description=(0,u.h2)("modal__description",""),this.confirmButton=(0,r.A)({className:"modal__button button",textContent:"OK",buttonType:"button",clickHandler:this.closeModal}),this.contentComponent=(0,u.y4)({className:"modal__content"},this.description,this.confirmButton),this.append(this.contentComponent),A.A.on(f.A.SOCKET_STATE_CHANGE,this.onSocketDisconnect),A.A.on(f.A.MODAL_ERROR,this.onAuthError),window.addEventListener("popstate",()=>{A.A.off(f.A.SOCKET_STATE_CHANGE,this.onSocketDisconnect),A.A.off(f.A.MODAL_ERROR,this.onAuthError)},{once:!0})}}},342:(y,v,E)=>{E.d(v,{A:()=>f});var o=E(256),u=Object.defineProperty,r=(s,l,d)=>l in s?u(s,l,{enumerable:!0,configurable:!0,writable:!0,value:d}):s[l]=d,A=(s,l,d)=>(r(s,typeof l!="symbol"?l+"":l,d),d);class f extends o.A{constructor(l){super({className:"app-container__page"}),A(this,"router"),this.router=l}}},54:(y,v,E)=>{E.d(v,{A:()=>u});var o=(r=>(r.SOCKET_STATE_CHANGE="socketStateChange",r.SOCKET_MSG_SENT="socketMsgSent",r.SOCKET_MSG_RECEIVED="socketMsgReceived",r.MODAL_ERROR="modalError",r.CONTACTS_UPDATED="contactsUpdated",r.MESSAGE_SENT="messageSent",r.MESSAGE_RECEIVED="messageReceived",r.CONTACT_SELECTION_CLICK="contactSelectionClick",r.SEND_BTN_CLICK="sendBtnClick",r.SEND_EDITED_BTN_CLICK="sendEditedBtnClick",r.DIALOGUE_CLICK="dialogueClick",r.USER_SCROLL="userScroll",r.EDIT_BTN_CLICK="editBtnClick",r.DELETE_BTN_CLICK="deleteBtnClick",r.SELECTED_LOGIN_CHANGED="selectedLoginChanged",r.SELECTED_ACTIVITY_CHANGED="selectedActivityChanged",r.MSG_CONTENT_UPDATED="msgContentUpdated",r))(o||{});const u=o},747:(y,v,E)=>{E.d(v,{A:()=>u});var o=(r=>(r.LOGIN_CURRENT="USER_LOGIN",r.LOGOUT_CURRENT="USER_LOGOUT",r.LOGIN_EXTERNAL="USER_EXTERNAL_LOGIN",r.LOGOUT_EXTERNAL="USER_EXTERNAL_LOGOUT",r.ACTIVE_USERS="USER_ACTIVE",r.INACTIVE_USERS="USER_INACTIVE",r.MSG_SEND="MSG_SEND",r.MSG_FROM_USER="MSG_FROM_USER",r.MSG_DELIVERED="MSG_DELIVER",r.MSG_READ="MSG_READ",r.MSG_DELETE="MSG_DELETE",r.MSG_EDIT="MSG_EDIT",r.ERROR="ERROR",r))(o||{});const u=o},849:(y,v,E)=>{E.d(v,{H4:()=>D,Nt:()=>d,P8:()=>l,Yo:()=>N,h5:()=>K,n1:()=>M,qR:()=>L});var o=E(368),u=E(747);function r(_){if(_===void 0)throw new Error("Value not defined");if(_===null)throw new Error("Value is null")}function A(_){return _!=null}function f(_,g){if(r(_),!(_ instanceof g))throw new TypeError("Wrong object type")}const s=(_,g,a)=>{const w=_.querySelector(g);return f(w,a),w},l=(_,g)=>{const{target:a}=_;return a instanceof HTMLElement?a.closest(g):null},d=(_,g)=>({id:crypto.randomUUID(),type:g,payload:_}),M=_=>d({message:{to:o.A.getSelectedContactLogin(),text:_}},u.A.MSG_SEND),L=_=>d({user:{login:_}},u.A.MSG_FROM_USER),K=_=>d({message:{id:_}},u.A.MSG_READ),N=_=>d({message:{id:_}},u.A.MSG_DELETE),D=(_,g)=>d({message:{id:_,text:g}},u.A.MSG_EDIT)}}]);
